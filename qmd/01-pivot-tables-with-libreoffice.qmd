---
title: "Discharge of River Elbe: Data Management with LibreOffice"
date: "2025-11-16"

format:
  html:
    theme: light  
    toc: true

webr:
  show-startup-message: false
  emulate-r: true
  packages: ["readxl", "dplyr"] # ajoute d'autres packages si nécessaire
filters:
  - webr
---


## Introduction

Planning and maintenance of waterways and rivers needs adequate measurements and data.
Raw time series can often be long and confusing, so a first step is aggregation and visualization.

**Scientific aim:** plot an average year and calculate monthly averages, minima and maxima of the discharge.



## Methods
### Diagram

```{mermaid}
graph TD
    A[Raw daily data - Elbe River]
    A --> B[Step 1: Data Acquisition]
    B --> C[Download CSV from URL]
    C --> D[Inspect data structure]
    
    D --> E[Step 2: Preprocessing]
    E --> F[Rename columns]
    F --> G[Convert dates]
    G --> H[Extract year/month/day]
    H --> I[Extract weekday/DOY]
    
    I --> J[Step 3: Aggregation]
    J --> K[Monthly aggregation]
    J --> L[Daily aggregation]
    J --> M[Annual aggregation]
    
    K --> N[Step 4: Visualization]
    L --> O[Step 4: Visualization]
    J --> P[Step 5: Exploration]
    J --> Q[Step 5: Exploration]
    
    N --> R[Results: Seasonal]
    O --> S[Results: Interannual]
    P --> T[Results: Yearly]
    Q --> U[Results: Accumulation]
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#f3e5f5
    style D fill:#f3e5f5
    style E fill:#f3e5f5
    style F fill:#f3e5f5
    style G fill:#f3e5f5
    style H fill:#f3e5f5
    style I fill:#f3e5f5
    style J fill:#e8f5e8
    style K fill:#e8f5e8
    style L fill:#e8f5e8
    style M fill:#e8f5e8
    style N fill:#fff3e0
    style O fill:#fff3e0
    style P fill:#fce4ec
    style Q fill:#fce4ec
    style R fill:#e8f5e8,stroke:#333
    style S fill:#e8f5e8,stroke:#333
    style T fill:#e8f5e8,stroke:#333
    style U fill:#e8f5e8,stroke:#333
```

The approach demonstrates the use of pivot tables for aggregating data according to certain criteria.
We will also use date and time computation to derive aggregation criteria from a single date column.

The data set consists of daily measurements for discharge of the Elbe River in Dresden (daily discharge sum in $\mathrm{m^3 d^{-1}}$).

Data were kindly provided by the German Federal Institute for Hydrology (BfG).



## Task 1

### 1. Download the data and inspect it

```{webr-r}
# Example code if CSV is used instead of ODS
url <- "https://tpetzoldt.github.io/datasets/data/elbe-1806.csv"
elbe <- read.csv(url)

head(elbe)
```



### 2. Create date categories

```{webr-r}

library(dplyr)
elbe <- elbe %>% 
  rename(Date = date)
elbe$year <- as.numeric(format(as.Date(elbe$Date), "%Y"))
elbe$month <- as.numeric(format(as.Date(elbe$Date), "%m"))
elbe$day <- as.numeric(format(as.Date(elbe$Date), "%d"))
elbe$weekday <- as.numeric(format(as.Date(elbe$Date), "%u"))
elbe$doy <- as.numeric(format(as.Date(elbe$Date), "%j"))

head(elbe)
```



### 3. Aggregate data

```{webr-r}
library(dplyr)

# Monthly averages
monthly_avg <- elbe %>%
  group_by(year, month) %>%
  summarise(mean_discharge = mean(discharge, na.rm=TRUE),
            min_discharge = min(discharge, na.rm=TRUE),
            max_discharge = max(discharge, na.rm=TRUE),.groups ="drop")

head(monthly_avg)
```


### 4. Average year plot

```{webr-r}
library(ggplot2)

avg_year <- elbe %>%
  group_by(doy) %>%
  summarise(mean_discharge = mean(discharge, na.rm=TRUE),
            min_discharge = min(discharge, na.rm=TRUE),
            max_discharge = max(discharge, na.rm=TRUE))

ggplot(avg_year, aes(x=doy)) +
  geom_line(aes(y=mean_discharge), color="blue", linewidth=1) +
  geom_ribbon(aes(ymin=min_discharge, ymax=max_discharge), alpha=0.2)
```



### 5. Annual discharge sum

```{webr-r}
annual_sum <- elbe %>%
  group_by(year) %>%
  summarise(total_discharge = sum(discharge, na.rm=TRUE))

ggplot(annual_sum, aes(x=year, y=total_discharge)) +
  geom_col(fill="steelblue") +
  labs(y="Annual discharge", x="Year")
```



### 6. Additional explorations

```{webr-r}
## Regrouper par décennies
library(dplyr)
library(ggplot2)

elbe_decade <- elbe %>%
  mutate(decade = floor(year / 10) * 10) %>%  # 1990, 2000, 2010, etc.
  mutate(decade_label = paste0(decade, "s"))

ggplot(elbe_decade, aes(x = doy, y = discharge, color = factor(decade_label))) +
  geom_point(alpha = 0.1, size = 0.5) +
  geom_smooth(aes(group = 1), method = "loess", formula = y ~ x,
              color = "black", linewidth = 1.5, se = FALSE) +
  labs(color = "Decade",
       x = "Day of Year",
       y = "Daily Discharge (m³/day)",
       title = "Discharge Patterns by Decade") +
  scale_color_viridis_d() +  # Palette limitée de couleurs
  theme_bw()
```





## Conclusion

This study demonstrated a comprehensive methodology for analyzing hydrological time series data, using the daily discharge of the Elbe River in Dresden as a case study. The analysis pipeline was organized around five key steps:

## Key Learnings

1. **Data Structuring**: Transforming raw data into usable time series requires crucial preprocessing steps, including date conversion and extraction of temporal variables (year, month, day of year).

2. **Multi-level Aggregation**: Analysis at different temporal scales (daily, monthly, annual) reveals complementary patterns:
   - Monthly aggregation highlights seasonal variability
   - The average year plot illustrates the annual hydrological cycle
   - Annual totals help identify interannual trends

3. **Informative Visualizations**: Different visualization types (average year plot with variability bands, annual histograms, temporal scatter plots) provide specific and complementary insights into the hydrological system's behavior.

## Practical Implications

For waterway and river management, this approach enables:
- Identification of characteristic high and low water periods
- Detection of anomalies or changes in hydrological regimes
- Provision of reference data for planning and maintenance
- Effective communication of complex patterns through synthesized visualizations

## Future Perspectives

The presented methods are transferable to other river systems and types of environmental data. The aggregation and visualization steps provide a solid foundation for more advanced analyses, such as long-term trend detection, flood frequency analysis, or studying climate change impacts on hydrological regimes.

This study illustrates how fundamental data management and analysis techniques can transform complex raw measurements into actionable information for sustainable water resource management. The systematic approach from data acquisition through preprocessing, aggregation, and visualization provides a reproducible framework that can be adapted to various hydrological monitoring and research contexts.

