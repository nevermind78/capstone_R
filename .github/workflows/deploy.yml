name: Deploy Quarto Website

on:
  push:
    branches: [main]

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install ALL required R packages
        run: |
          echo "ðŸ“¦ Installation des packages R..."
          
          # Packages ESSENTIELS pour Quarto
          Rscript -e "install.packages(c('rmarkdown', 'knitr'), repos = 'https://cloud.r-project.org')"
          
          # Packages pour le code linking (warning rÃ©solu)
          Rscript -e "install.packages(c('downlit', 'xml2'), repos = 'https://cloud.r-project.org')"
          
          # Packages pour VOS analyses (basÃ©s sur vos fichiers .qmd)
          Rscript -e "install.packages(c('dplyr', 'ggplot2', 'readxl', 'tidyr', 'lubridate'), repos = 'https://cloud.r-project.org')"
          
          # Packages pour les tests statistiques
          Rscript -e "install.packages(c('car', 'lmtest', 'nortest', 'MASS'), repos = 'https://cloud.r-project.org')"
          
          # Packages SPÃ‰CIFIQUES dans vos fichiers
          Rscript -e "install.packages(c('gplots'), repos = 'https://cloud.r-project.org')"  # <-- AJOUTÃ‰
          
          # Autres packages potentiellement nÃ©cessaires
          Rscript -e "install.packages(c('RColorBrewer', 'gridExtra', 'scales'), repos = 'https://cloud.r-project.org')"

      - name: Verify WebR extensions
        run: |
          echo "ðŸ” VÃ©rification des extensions..."
          if [ ! -d "_extensions/coatless" ]; then
            echo "ðŸ“¦ Installation de WebR extension..."
            quarto add coatless/webr --no-prompt
          else
            echo "âœ… Extension WebR prÃ©sente"
          fi

      - name: Install system dependencies for gplots
        run: |
          echo "ðŸ“¥ Installation des dÃ©pendances systÃ¨me pour gplots..."
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libgmp-dev \
            libmpfr-dev

      - name: Render Quarto website
        run: |
          echo "ðŸš€ Rendu du site Quarto..."
          
          # Nettoyer
          rm -rf docs/
          
          # Option 1: Rendre tout
          quarto render --to html
          
          # Option 2: Rendre fichier par fichier (plus de contrÃ´le)
          # quarto render index.qmd --to html
          # for qmd in qmd/*.qmd; do
          #   echo "ðŸ“„ Rendu de $qmd"
          #   quarto render "$qmd" --to html || echo "âš ï¸ Ã‰chec pour $qmd, continuation..."
          # done
          
          # GÃ©rer le fichier index
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "âœ… index.qmd.html â†’ index.html"
          fi
          
          # S'assurer qu'il y a un index.html
          if [ ! -f "docs/index.html" ]; then
            echo '<!DOCTYPE html>
            <html>
            <head>
              <title>Data Analysis Lab</title>
              <meta http-equiv="refresh" content="0;url=qmd/">
            </head>
            <body>
              <p>Redirecting to exercises...</p>
            </body>
            </html>' > docs/index.html
          fi
          
          # Fichier obligatoire pour GitHub Pages
          touch docs/.nojekyll
          
          echo "âœ… Rendu terminÃ©"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v3