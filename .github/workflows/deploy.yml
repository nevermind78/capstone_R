name: Deploy Quarto Site

on:
  push:
    branches: [main]

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup Python and Jupyter
        run: |
          echo "üêç Installation de Python et Jupyter..."
          
          # Mettre √† jour pip
          python3 -m pip install --upgrade pip
          
          # Installer Jupyter et ses d√©pendances
          python3 -m pip install jupyter nbformat ipykernel ipywidgets
          
          # Installer les packages Python communs pour l'analyse de donn√©es
          python3 -m pip install pandas numpy matplotlib seaborn scipy
          
          # V√©rifier l'installation
          python3 -c "import jupyter; import nbformat; print('‚úÖ Jupyter et nbformat install√©s')"

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install R packages
        run: |
          echo "üì¶ Installation des packages R..."
          
          # Packages essentiels pour Quarto
          Rscript -e "install.packages(c('rmarkdown', 'knitr'), repos = 'https://cloud.r-project.org')"
          
          # Packages pour WebR et analyses
          Rscript -e "install.packages(c('dplyr', 'ggplot2', 'readxl', 'tidyr', 'lubridate', 'gplots'), repos = 'https://cloud.r-project.org')"
          
          # Packages pour les tests statistiques
          Rscript -e "install.packages(c('car', 'lmtest', 'nortest', 'MASS'), repos = 'https://cloud.r-project.org')"
          
          # V√©rification
          Rscript -e "cat('‚úÖ Packages R install√©s\\n')"

      - name: Install WebR extension
        run: |
          if [ ! -d "_extensions/coatless" ]; then
            quarto add coatless/webr --no-prompt
          fi

      - name: Render Quarto website
        run: |
          echo "üöÄ Rendu du site Quarto..."
          
          # Nettoyer
          rm -rf docs/
          
          # Rendre tout le site
          quarto render --to html
          
          # G√©rer le fichier index
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "‚úÖ index.qmd.html ‚Üí index.html"
          fi
          
          # S'assurer qu'il y a un index.html
          if [ ! -f "docs/index.html" ]; then
            echo '<!DOCTYPE html>
            <html>
            <head>
              <title>Data Analysis Lab</title>
              <meta http-equiv="refresh" content="0;url=qmd/">
            </head>
            <body>
              <p>Redirecting to exercises...</p>
            </body>
            </html>' > docs/index.html
          fi
          
          # Fichier obligatoire pour GitHub Pages
          touch docs/.nojekyll
          
          echo "‚úÖ Rendu termin√©"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v3