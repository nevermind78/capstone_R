name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter with cache
        run: |
          echo "ðŸ Installation Python/Jupyter avec jupyter-cache..."
          python3 -m pip install --upgrade pip
          # Installer jupyter-cache pour la mise en cache
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache nbclient
          
          echo "âœ… Versions installÃ©es :"
          python3 -c "import jupyter_cache; print(f'jupyter-cache: {jupyter_cache.__version__}')"
          python3 -m jupyter --version

      - name: Setup R with RSPM (binary packages)
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          # Utiliser RStudio Package Manager pour binaires Linux
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v3
        id: r-cache
        with:
          path: |
            /usr/local/lib/R/site-library
            ~/R/library
            /opt/R/$(Rscript -e "cat(R.version$major, R.version$minor, sep='.')")/library
          key: ${{ runner.os }}-r-packages-${{ hashFiles('.github/workflows/deploy.yml') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-

      - name: Install system dependencies for binary packages
        run: |
          echo "ðŸ“¦ Installation des dÃ©pendances systÃ¨me pour packages binaires..."
          sudo apt-get update -qq
          # DÃ©pendances minimales pour les packages binaires R
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libxml2-dev \
            libssl-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libgmp3-dev \
            libmpfr-dev \
            liblapack-dev \
            libblas-dev

      - name: Install R packages from binaries (NO SOURCE)
        if: steps.r-cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ Installation RAPIDE des packages R depuis binaires..."
          
          # Configuration R pour utiliser les binaires
          cat > ~/.Rprofile << 'EOF'
          # Force binary installation on Ubuntu 22.04
          options(
            # RStudio Package Manager for Ubuntu 22.04 binaries
            repos = c(
              RSPM = "https://packagemanager.rstudio.com/cran/__linux__/jammy/latest",
              CRAN = "https://cran.rstudio.com"
            ),
            # Force binary installation
            install.packages.compile.from.source = "never",
            install.packages.check.source = "no",
            # Parallel installation
            Ncpus = 4,
            # Skip downloads if already installed
            INSTALL_opts = "--no-multiarch --no-docs --no-test-load --no-byte-compile",
            # Timeout
            timeout = 300
          )
          EOF
          
          # PremiÃ¨re passe: installer les packages de base
          echo "ðŸ“¥ Installation des packages essentiels..."
          Rscript -e "
          # Packages prioritaires (petits)
          priority_pkgs <- c('rmarkdown', 'knitr')
          install.packages(priority_pkgs, type = 'binary', quiet = FALSE)
          
          # Packages tidyverse (disponibles en binaires)
          tidy_pkgs <- c('dplyr', 'ggplot2', 'tidyr', 'readxl', 'lubridate', 'stringr', 'purrr')
          install.packages(tidy_pkgs, type = 'binary', quiet = FALSE)
          
          # Packages statistiques
          stats_pkgs <- c('car', 'lmtest', 'gplots')
          install.packages(stats_pkgs, type = 'binary', quiet = FALSE)
          
          # Packages pour WebR si nÃ©cessaire
          webr_pkgs <- c('rlang', 'tibble', 'forcats')
          install.packages(webr_pkgs, type = 'binary', quiet = FALSE)
          
          cat('\\nâœ… Installation terminÃ©e!\\n')
          cat('Packages installÃ©s:\\n')
          print(installed.packages()[, c('Package', 'Version')])
          "
          
          echo "â±ï¸ Installation terminÃ©e en $(($SECONDS / 60)) minutes"

      - name: Verify binary installation
        run: |
          echo "ðŸ” VÃ©rification de l'installation binaire..."
          Rscript -e "
          pkgs <- c('dplyr', 'ggplot2', 'car', 'lmtest')
          for(pkg in pkgs) {
            if(requireNamespace(pkg, quietly = TRUE)) {
              cat('âœ…', pkg, 'installÃ©\\n')
            } else {
              cat('âŒ', pkg, 'NON installÃ©\\n')
            }
          }
          # VÃ©rifier si c'est binaire
          cat('\\nðŸ“ Librairie R:', .libPaths()[1], '\\n')
          "

      - name: Clean cache and temporary files
        run: |
          echo "ðŸ§¹ Nettoyage des fichiers temporaires..."
          rm -rf _freeze/ .quarto-cache/ 2>/dev/null || true
          find . -name "*.quarto_ipynb" -type f -delete 2>/dev/null || true

      - name: Render website with jupyter-cache
        run: |
          echo "ðŸš€ Rendu du site web avec cache..."
          
          # Activer le cache Jupyter pour Quarto
          export QUARTO_JUPYTER_CACHE=true
          
          # Rendu avec cache
          quarto render --cache
          
          # Alternative si le cache pose problÃ¨me
          # quarto render --no-cache
          
          # Post-traitement
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
          fi
          
          # Pour GitHub Pages
          touch docs/.nojekyll
          
          echo "âœ… Site gÃ©nÃ©rÃ© dans docs/"
          ls -la docs/*.html | head -5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3